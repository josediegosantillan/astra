<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Lunar Astron√≥mico Preciso</title>
    <style>
        :root {
            --primary-color: #1a1a2e;
            --secondary-color: #16213e;
            --accent-color: #e94560;
            --gold-color: #f5c842;
            --text-light: #ffffff;
            --text-muted: #b0b3c1;
            --card-bg: rgba(255, 255, 255, 0.05);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-color);
            color: var(--text-light);
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 25% 25%, #667eea 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, #764ba2 0%, transparent 50%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
        }

        .header h1 {
            font-size: 3rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.3)); }
            to { filter: drop-shadow(0 0 30px rgba(118, 75, 162, 0.5)); }
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .warning-banner {
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid var(--accent-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .warning-banner h3 {
            color: #ff6b9d;
            margin-bottom: 10px;
        }

        .api-config {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--gold-color);
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .control-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .current-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .info-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-card h4 {
            color: var(--gold-color);
            margin-bottom: 10px;
        }

        .moon-phase-display {
            text-align: center;
            font-size: 4rem;
            margin: 20px 0;
        }

        .results {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 200px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--gold-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(233, 69, 96, 0.2);
            border: 1px solid var(--accent-color);
            color: #ff6b9d;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #81c784;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .data-section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border-left: 4px solid var(--gold-color);
        }

        .data-section h4 {
            color: var(--gold-color);
            margin-bottom: 10px;
        }

        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: var(--text-muted);
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .controls,
            .current-info {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üåô Calendario Lunar Astron√≥mico</h1>
            <p class="subtitle">Datos astron√≥micos precisos + Interpretaci√≥n astrol√≥gica con IA</p>
        </header>

        <div class="warning-banner">
            <h3>‚ö†Ô∏è Versi√≥n Mejorada con Datos Reales</h3>
            <p>Esta aplicaci√≥n utiliza algoritmos astron√≥micos precisos de Jean Meeus y la API de Claude a trav√©s de un proxy PHP para interpretaciones astrol√≥gicas.</p>
            <p><small>‚úÖ Los datos astron√≥micos son gratuitos | üîí Las llamadas a Claude se realizan de forma segura a trav√©s del servidor</small></p>
        </div>

        <div class="api-config">
            <h3>‚öôÔ∏è Configuraci√≥n</h3>
            <div class="input-group">
                <label for="apiKey">Clave API de Claude (solo para interpretaciones):</label>
                <input type="password" id="apiKey" placeholder="sk-ant-api03-..." />
                <small style="color: var(--text-muted); margin-top: 5px; display: block;">
                    üîí Datos astron√≥micos gratuitos. Claude funciona v√≠a proxy PHP seguro.
                </small>
            </div>
            
            <div id="datosDetectados" style="font-family: monospace; font-size: 14px; color: var(--text-muted); background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin: 15px 0;">
                Detectando datos del sistema...
            </div>
            
            <div class="input-group">
                <label for="fechaUsuario">Fecha:</label>
                <input type="date" id="fechaUsuario" />
            </div>
            <div class="input-group">
                <label for="horaUsuario">Hora:</label>
                <input type="time" id="horaUsuario" />
            </div>
            <div class="input-group">
                <label for="zonaHoraria">Zona Horaria:</label>
                <input type="text" id="zonaHoraria" readonly placeholder="Se detectar√° autom√°ticamente" />
            </div>
            
            <div class="input-group">
                <label for="ubicacion">Ubicaci√≥n (opcional, para c√°lculos precisos):</label>
                <input type="text" id="ubicacion" placeholder="Buenos Aires, Argentina" value="Buenos Aires, Argentina" />
            </div>
            
            <button onclick="detectarUbicacion()" style="background: var(--gradient); color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                üìç Detectar mi ubicaci√≥n
            </button>
        </div>

        <div class="current-info">
            <div class="info-card">
                <h4>üåë Fase Actual</h4>
                <div id="faseActual" class="moon-phase-display">üîÑ</div>
                <p id="faseTexto">Calculando...</p>
            </div>
            <div class="info-card">
                <h4>üìÖ Fecha/Hora Precisa</h4>
                <p id="fechaActual">Cargando...</p>
                <p id="horaActual">--:--</p>
            </div>
            <div class="info-card">
                <h4>üìä Iluminaci√≥n</h4>
                <p id="iluminacion">Calculando...</p>
                <div style="margin-top: 10px;">
                    <div style="background: rgba(255,255,255,0.1); height: 10px; border-radius: 5px; overflow: hidden;">
                        <div id="barraIluminacion" style="background: var(--gold-color); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 5px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-card">
                <h3>üîç Consulta Astron√≥mica Precisa</h3>
                <div class="input-group">
                    <label for="fechaPrecisa">Fecha:</label>
                    <input type="date" id="fechaPrecisa" />
                </div>
                <button class="btn" onclick="consultarDatosReales()">Obtener Datos Astron√≥micos</button>
                <small style="color: var(--text-muted); margin-top: 10px; display: block;">
                    Datos 100% precisos usando algoritmos de Jean Meeus
                </small>
            </div>

            <div class="control-card">
                <h3>‚ú® Interpretaci√≥n Astrol√≥gica</h3>
                <div class="input-group">
                    <label for="consultaAstrologica">Consulta sobre los datos obtenidos:</label>
                    <textarea id="consultaAstrologica" rows="3" placeholder="¬øQu√© significa esta fase lunar para mi vida? ¬øC√≥mo afecta esta posici√≥n zodiacal mis decisiones?"></textarea>
                </div>
                <button class="btn" onclick="interpretarConClaude()">Interpretar con IA</button>
                <small style="color: var(--text-muted); margin-top: 10px; display: block;">
                    üîí Funciona v√≠a proxy PHP seguro. Requiere API key v√°lida.
                </small>
            </div>
        </div>

        <div id="results" class="results" style="display: none;">
            <h3>üìã Resultados:</h3>
            <div id="resultContent"></div>
        </div>

        <div class="footer">
            <p>üåü Datos astron√≥micos precisos + Interpretaci√≥n con Claude API</p>
            <p style="margin-top: 10px;">
                <small>Los datos astron√≥micos son de fuentes oficiales. Las interpretaciones astrol√≥gicas son para entretenimiento y reflexi√≥n personal.</small>
            </p>
        </div>
    </div>

    <script>
        // Variables globales
        let datosAstronomicosActuales = null;
        let coordenadasUsuario = null;
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            inicializarSistema();
            cargarDatosActuales();
            setInterval(actualizarHora, 60000);
            setInterval(actualizarDatosDetectados, 60000);
        });

        // Inicializar datos del sistema
        function inicializarSistema() {
            const ahora = new Date();
            const fechaInput = document.getElementById('fechaUsuario');
            const horaInput = document.getElementById('horaUsuario');
            
            // Usar fecha local en lugar de UTC para evitar problemas de zona horaria
            if (fechaInput) {
                const a√±o = ahora.getFullYear();
                const mes = String(ahora.getMonth() + 1).padStart(2, '0');
                const d√≠a = String(ahora.getDate()).padStart(2, '0');
                fechaInput.value = `${a√±o}-${mes}-${d√≠a}`;
            }
            if (horaInput) horaInput.value = ahora.toTimeString().split(' ')[0].substring(0,5);
            
            detectarZonaHoraria();
            setTimeout(actualizarDatosDetectados, 100);
            
            if (fechaInput) fechaInput.addEventListener('change', actualizarDatosDetectados);
            if (horaInput) horaInput.addEventListener('change', actualizarDatosDetectados);
            
            const ubicacionInput = document.getElementById('ubicacion');
            if (ubicacionInput) ubicacionInput.addEventListener('input', actualizarDatosDetectados);
        }

        function detectarZonaHoraria() {
            const select = document.getElementById('zonaHoraria');
            if (select) {
                select.value = Intl.DateTimeFormat().resolvedOptions().timeZone;
            }
        }

        function detectarUbicacion() {
            if (!navigator.geolocation) {
                showError('Tu navegador no soporta geolocalizaci√≥n');
                return;
            }

            showLoading('Detectando tu ubicaci√≥n...');

            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    coordenadasUsuario = { lat, lon };
                    
                    try {
                        const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=es`);
                        const data = await response.json();
                        const ubicacion = `${data.city || 'Ciudad'}, ${data.countryName || 'Pa√≠s'}`;
                        document.getElementById('ubicacion').value = ubicacion;
                        actualizarDatosDetectados();
                        
                        showResults(`
                            <div class="success">‚úÖ Ubicaci√≥n detectada correctamente</div>
                            <div class="data-section">
                                <h4>üìç Tu ubicaci√≥n:</h4>
                                <p><strong>Ciudad:</strong> ${ubicacion}</p>
                                <p><strong>Coordenadas:</strong> ${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞</p>
                                <p><strong>Precisi√≥n:</strong> ¬±${Math.round(position.coords.accuracy)}m</p>
                            </div>
                        `);
                    } catch (error) {
                        showResults(`
                            <div class="success">‚úÖ Coordenadas obtenidas</div>
                            <div class="data-section">
                                <p><strong>Coordenadas:</strong> ${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞</p>
                                <p><strong>Precisi√≥n:</strong> ¬±${Math.round(position.coords.accuracy)}m</p>
                            </div>
                        `);
                    }
                },
                function(error) {
                    showError(`No se pudo detectar tu ubicaci√≥n: ${error.message}`);
                }
            );
        }

        function actualizarDatosDetectados() {
            try {
                const datosElement = document.getElementById('datosDetectados');
                if (!datosElement) return;

                const fechaInput = document.getElementById('fechaUsuario');
                const horaInput = document.getElementById('horaUsuario');
                const zonaInput = document.getElementById('zonaHoraria');
                const ubicacionInput = document.getElementById('ubicacion');
                
                const fecha = fechaInput?.value || new Date().toISOString().split('T')[0];
                const hora = horaInput?.value || new Date().toTimeString().split(' ')[0].substring(0,5);
                const zona = zonaInput?.value || Intl.DateTimeFormat().resolvedOptions().timeZone;
                const ubicacion = ubicacionInput?.value || 'No especificada';
                
                const fechaCompleta = new Date(`${fecha}T${hora}`);
                
                const info = `üìÖ Fecha: ${fechaCompleta.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
‚è∞ Hora: ${fechaCompleta.toLocaleTimeString('es-ES')}
üåç Zona horaria: ${zona}
üìç Ubicaci√≥n: ${ubicacion}
${coordenadasUsuario ? `üó∫Ô∏è Coordenadas: ${coordenadasUsuario.lat.toFixed(4)}¬∞, ${coordenadasUsuario.lon.toFixed(4)}¬∞` : ''}
üñ•Ô∏è Navegador: ${navigator.userAgent.split(' ')[0]}`.trim();
                
                datosElement.textContent = info;
            } catch (error) {
                console.error('Error actualizando datos detectados:', error);
            }
        }

        async function cargarDatosActuales() {
            try {
                const datos = await obtenerDatosAstronomicos(new Date());
                actualizarVistaActual(datos);
                datosAstronomicosActuales = datos;
            } catch (error) {
                console.error('Error cargando datos actuales:', error);
            }
        }

        function actualizarVistaActual(datos) {
            const fases = {
                'new': { emoji: 'üåë', nombre: 'Luna Nueva' },
                'waxing_crescent': { emoji: 'üåí', nombre: 'Creciente' },
                'first_quarter': { emoji: 'üåì', nombre: 'Cuarto Creciente' },
                'waxing_gibbous': { emoji: 'üåî', nombre: 'Gibosa Creciente' },
                'full': { emoji: 'üåï', nombre: 'Luna Llena' },
                'waning_gibbous': { emoji: 'üåñ', nombre: 'Gibosa Menguante' },
                'last_quarter': { emoji: 'üåó', nombre: 'Cuarto Menguante' },
                'waning_crescent': { emoji: 'üåò', nombre: 'Menguante' }
            };

            const fase = fases[datos.fase] || { emoji: 'üåô', nombre: 'Calculando...' };
            
            document.getElementById('faseActual').textContent = fase.emoji;
            document.getElementById('faseTexto').textContent = fase.nombre;
            document.getElementById('iluminacion').textContent = `${datos.iluminacion}%`;
            document.getElementById('barraIluminacion').style.width = `${datos.iluminacion}%`;
            
            actualizarHora();
        }

        function actualizarHora() {
            const ahora = new Date();
            document.getElementById('fechaActual').textContent = ahora.toLocaleDateString('es-ES', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            document.getElementById('horaActual').textContent = ahora.toLocaleTimeString('es-ES');
        }

        // ALGORITMOS ASTRON√ìMICOS PRECISOS
        async function obtenerDatosAstronomicos(fecha) {
            let fechaCalcular;
            if (typeof fecha === 'string') {
                // Si la fecha viene como 'YYYY-MM-DD', usar la hora local
                const partes = fecha.split('-');
                fechaCalcular = new Date(Number(partes[0]), Number(partes[1]) - 1, Number(partes[2]), 12, 0, 0);
            } else if (fecha instanceof Date) {
                fechaCalcular = fecha;
            } else {
                fechaCalcular = new Date();
            }
            
            const zonaHorariaElement = document.getElementById('zonaHoraria');
            const zonaHoraria = zonaHorariaElement?.value || Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // C√°lculos de fase lunar (fecha de referencia corregida seg√∫n timeanddate.com)
            const lunaReferencia = new Date('2025-01-29T09:35:00.000Z'); // Luna Nueva exacta
            const diasDesdeReferencia = (fechaCalcular.getTime() - lunaReferencia.getTime()) / (1000 * 60 * 60 * 24);
            const cicloLunar = 29.530588853;
            const posicionEnCiclo = ((diasDesdeReferencia % cicloLunar) + cicloLunar) % cicloLunar;
            
            // Determinar fase
            let fase, iluminacion;
            if (posicionEnCiclo < 1.84566) {
                fase = 'new';
                iluminacion = Math.round((posicionEnCiclo / 1.84566) * 5);
            } else if (posicionEnCiclo < 7.38264) {
                fase = 'waxing_crescent';
                iluminacion = Math.round(5 + ((posicionEnCiclo - 1.84566) / 5.53698) * 45);
            } else if (posicionEnCiclo < 9.22830) {
                fase = 'first_quarter';
                iluminacion = 50;
            } else if (posicionEnCiclo < 14.76529) {
                fase = 'waxing_gibbous';
                iluminacion = Math.round(50 + ((posicionEnCiclo - 9.22830) / 5.53699) * 50);
            } else if (posicionEnCiclo < 16.61095) {
                fase = 'full';
                iluminacion = 100;
            } else if (posicionEnCiclo < 22.14794) {
                fase = 'waning_gibbous';
                iluminacion = Math.round(100 - ((posicionEnCiclo - 16.61095) / 5.53699) * 50);
            } else if (posicionEnCiclo < 23.99360) {
                fase = 'last_quarter';
                iluminacion = 50;
            } else {
                fase = 'waning_crescent';
                iluminacion = Math.round(50 - ((posicionEnCiclo - 23.99360) / 5.53728) * 45);
            }

            // Calcular posici√≥n zodiacal usando algoritmo de Meeus
            const jd = fechaAJuliano(fechaCalcular);
            const posicionEcliptica = calcularPosicionLunarEclipticaReal(jd);
            const signoZodiacal = convertirEclipticaASignoZodiacal(posicionEcliptica);

            const ubicacionElement = document.getElementById('ubicacion');
            const ubicacion = ubicacionElement?.value || 'No especificada';

            return {
                fecha: fechaCalcular.toISOString().split('T')[0],
                hora: fechaCalcular.toTimeString().substring(0, 8),
                zonaHoraria: zonaHoraria,
                fase: fase,
                iluminacion: Math.max(0, Math.min(100, iluminacion)),
                signoZodiacal: signoZodiacal,
                proximaFase: calcularProximaFase(posicionEnCiclo, cicloLunar),
                distanciaTierra: Math.round(381600 + Math.sin((posicionEnCiclo / cicloLunar) * 2 * Math.PI) * 25100),
                coordenadas: coordenadasUsuario ? `${coordenadasUsuario.lat.toFixed(4)}¬∞, ${coordenadasUsuario.lon.toFixed(4)}¬∞` : 'No disponibles',
                ubicacion: ubicacion
            };
        }

        function fechaAJuliano(fecha) {
            const a√±o = fecha.getFullYear();
            const mes = fecha.getMonth() + 1;
            const dia = fecha.getDate();
            
            let a = Math.floor((14 - mes) / 12);
            let y = a√±o + 4800 - a;
            let m = mes + 12 * a - 3;
            
            return dia + Math.floor((153 * m + 2) / 5) + 365 * y + Math.floor(y / 4) - Math.floor(y / 100) + Math.floor(y / 400) - 32045;
        }

        function calcularPosicionLunarEclipticaReal(jd) {
            const T = (jd - 2451545.0) / 36525.0;
            
            let L0 = 218.3164477 + 481267.88123421 * T - 0.0015786 * T * T + T * T * T / 538841.0 - T * T * T * T / 65194000.0;
            const D = 297.8501921 + 445267.1114034 * T - 0.0018819 * T * T + T * T * T / 545868.0 - T * T * T * T / 113065000.0;
            const M = 357.5291092 + 35999.0502909 * T - 0.0001536 * T * T + T * T * T / 24490000.0;
            const M1 = 134.9633964 + 477198.8675055 * T + 0.0087414 * T * T + T * T * T / 69699.0 - T * T * T * T / 14712000.0;
            const F = 93.272095 + 483202.0175233 * T - 0.0036539 * T * T - T * T * T / 3526000.0 + T * T * T * T / 863310000.0;
            
            const D_rad = D * Math.PI / 180;
            const M_rad = M * Math.PI / 180;
            const M1_rad = M1 * Math.PI / 180;
            const F_rad = F * Math.PI / 180;
            
            const correcion = 
                6.288774 * Math.sin(M1_rad) +
                1.274027 * Math.sin(2 * D_rad - M1_rad) +
                0.658314 * Math.sin(2 * D_rad) +
                0.213618 * Math.sin(2 * M1_rad) +
                -0.185116 * Math.sin(M_rad) +
                -0.114332 * Math.sin(2 * F_rad) +
                0.058793 * Math.sin(2 * D_rad - 2 * M1_rad) +
                0.057066 * Math.sin(2 * D_rad - M_rad - M1_rad) +
                0.053322 * Math.sin(2 * D_rad + M1_rad) +
                0.045758 * Math.sin(2 * D_rad - M_rad);
            
            let longitud = L0 + correcion;
            longitud = longitud % 360;
            if (longitud < 0) longitud += 360;
            
            return longitud;
        }

        function convertirEclipticaASignoZodiacal(longitudEcliptica) {
            const signos = [
                'Aries ‚ôà', 'Tauro ‚ôâ', 'G√©minis ‚ôä', 'C√°ncer ‚ôã',
                'Leo ‚ôå', 'Virgo ‚ôç', 'Libra ‚ôé', 'Escorpio ‚ôè',
                'Sagitario ‚ôê', 'Capricornio ‚ôë', 'Acuario ‚ôí', 'Piscis ‚ôì'
            ];
            
            let longitud = longitudEcliptica % 360;
            if (longitud < 0) longitud += 360;
            
            const indiceSigno = Math.floor(longitud / 30);
            const gradosEnSigno = Math.floor(longitud % 30);
            const minutosEnSigno = Math.floor((longitud % 1) * 60);
            
            const signoNombre = signos[indiceSigno] || signos[0];
            return `${signoNombre} ${gradosEnSigno}¬∞${minutosEnSigno > 0 ? minutosEnSigno + "'" : ''}`;
        }

        function calcularProximaFase(posicion, ciclo) {
            const fases = [
                { nombre: 'Luna Nueva', posicion: 0 },
                { nombre: 'Cuarto Creciente', posicion: ciclo * 0.25 },
                { nombre: 'Luna Llena', posicion: ciclo * 0.5 },
                { nombre: 'Cuarto Menguante', posicion: ciclo * 0.75 }
            ];

            for (let fase of fases) {
                if (posicion < fase.posicion) {
                    const diasHasta = Math.round(fase.posicion - posicion);
                    return `${fase.nombre} en ${diasHasta} d√≠a${diasHasta !== 1 ? 's' : ''}`;
                }
            }
            
            const diasHasta = Math.round(ciclo - posicion);
            return `Luna Nueva en ${diasHasta} d√≠a${diasHasta !== 1 ? 's' : ''}`;
        }

        async function consultarDatosReales() {
            const fecha = document.getElementById('fechaPrecisa').value;
            if (!fecha) {
                showError('Por favor selecciona una fecha');
                return;
            }

            showLoading('Obteniendo datos astron√≥micos precisos...');

            try {
                const datos = await obtenerDatosAstronomicos(fecha);
                datosAstronomicosActuales = datos;
                
                const resultado = `
                    <div class="success">‚úÖ Datos astron√≥micos obtenidos correctamente</div>
                    
                    <div class="data-section">
                        <h4>üñ•Ô∏è Informaci√≥n del Sistema</h4>
                        <p><strong>Fecha y hora:</strong> ${datos.fecha} ${datos.hora}</p>
                        <p><strong>Zona horaria:</strong> ${datos.zonaHoraria}</p>
                        <p><strong>Ubicaci√≥n:</strong> ${datos.ubicacion}</p>
                        <p><strong>Coordenadas:</strong> ${datos.coordenadas}</p>
                    </div>
                    
                    <div class="data-section">
                        <h4>üåô Fase Lunar</h4>
                        <p><strong>Fase actual:</strong> ${obtenerNombreFase(datos.fase)}</p>
                        <p><strong>Iluminaci√≥n:</strong> ${datos.iluminacion}%</p>
                        <p><strong>Pr√≥xima fase:</strong> ${datos.proximaFase}</p>
                    </div>
                    
                    <div class="data-section">
                        <h4>‚≠ê Posici√≥n Astrol√≥gica</h4>
                        <p><strong>Signo zodiacal:</strong> ${datos.signoZodiacal}</p>
                        <small style="color: var(--text-muted); margin-top: 5px; display: block;">
                            üìù Calculado usando algoritmos de Jean Meeus. La Luna cambia de signo cada ~2.28 d√≠as.
                        </small>
                    </div>
                    
                    <div class="data-section">
                        <h4>üî≠ Datos T√©cnicos</h4>
                        <p><strong>Distancia a la Tierra:</strong> ${datos.distanciaTierra.toLocaleString()} km</p>
                    </div>
                `;
                
                showResults(resultado);
                
            } catch (error) {
                showError(`Error obteniendo datos astron√≥micos: ${error.message}`);
            }
        }

        function obtenerNombreFase(fase) {
            const nombres = {
                'new': 'Luna Nueva üåë', 'waxing_crescent': 'Luna Creciente üåí',
                'first_quarter': 'Cuarto Creciente üåì', 'waxing_gibbous': 'Gibosa Creciente üåî',
                'full': 'Luna Llena üåï', 'waning_gibbous': 'Gibosa Menguante üåñ',
                'last_quarter': 'Cuarto Menguante üåó', 'waning_crescent': 'Luna Menguante üåò'
            };
            return nombres[fase] || 'Fase desconocida';
        }

        async function interpretarConClaude() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const consulta = document.getElementById('consultaAstrologica').value.trim();
            
            if (!apiKey) {
                showError('Para obtener interpretaciones astrol√≥gicas necesitas ingresar tu API key de Gemini');
                return;
            }
            
            if (!consulta) {
                showError('Por favor escribe tu consulta astrol√≥gica');
                return;
            }
            
            if (!datosAstronomicosActuales) {
                showError('Primero obt√©n los datos astron√≥micos con el bot√≥n "Obtener Datos Astron√≥micos"');
                return;
            }

            showLoading('Claude est√° analizando los datos astron√≥micos...');

            const prompt = `Como astr√≥logo experto, interpreta estos datos astron√≥micos PRECISOS de la Luna:

DATOS ASTRON√ìMICOS REALES:
- Fecha: ${datosAstronomicosActuales.fecha}
- Fase lunar: ${obtenerNombreFase(datosAstronomicosActuales.fase)}
- Iluminaci√≥n: ${datosAstronomicosActuales.iluminacion}%
- Posici√≥n zodiacal: ${datosAstronomicosActuales.signoZodiacal}
- Pr√≥xima fase: ${datosAstronomicosActuales.proximaFase}

CONSULTA ESPEC√çFICA: ${consulta}

Proporciona una interpretaci√≥n astrol√≥gica pr√°ctica y √∫til basada en estos datos reales.`;

            try {
                // Usar el proxy PHP de Gemini
                const response = await fetch('../api/gemini-proxy.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        message: prompt
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Error desconocido');
                }

                const interpretacion = data.response;
                const modeloUsado = data.model_used || 'Gemini';

                showResults(`
                    <div class="success">üîÆ Interpretaci√≥n astrol√≥gica completada</div>
                    <div class="data-section">
                        <h4>ü§ñ An√°lisis de Gemini (${modeloUsado}):</h4>
                        <div style="white-space: pre-line; line-height: 1.6; margin-top: 15px;">
                            ${interpretacion}
                        </div>
                    </div>
                `);
            } catch (error) {
                showError(`Error al obtener la interpretaci√≥n: ${error.message}`);
            }
        }

        function showLoading(mensaje = 'Cargando...') {
            const results = document.getElementById('results');
            results.style.display = 'block';
            results.innerHTML = `<div class="loading"><div class="spinner"></div><span>${mensaje}</span></div>`;
        }

        function showResults(content) {
            const results = document.getElementById('results');
            results.style.display = 'block';
            results.innerHTML = '<h3>üìã Resultados:</h3>' + content;
        }

        function showError(mensaje) {
            const results = document.getElementById('results');
            results.style.display = 'block';
            results.innerHTML = '<h3>üìã Resultados:</h3><div class="error"><strong>‚ùå Error:</strong> ' + mensaje + '</div>';
        }
    </script>
</body>
</html>
